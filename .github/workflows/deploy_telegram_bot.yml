name: Deploy Telegram Bot

on:
  push:
    branches: [main]
    paths:
      - .github/workflows/deploy_telegram_bot.yml
      - .github/scripts/deploy_telegram_ecs.sh
      - ronin/cli/telegram_ops.py
      - ronin/cli/main.py
      - Dockerfile
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region
        required: false
        default: us-east-1
      name_prefix:
        description: Resource prefix (cluster/repo naming)
        required: false
        default: ronin
      telegram_bot_token_ref:
        description: SSM parameter name or Secrets Manager id/arn for bot token
        required: false
        default: /ronin/telegram/bot_token
      telegram_chat_id_ref:
        description: SSM parameter name or Secrets Manager id/arn for chat id
        required: false
        default: /ronin/telegram/chat_id
      image_tag:
        description: Image tag override (default is commit SHA)
        required: false
        default: ""
      subnet_ids:
        description: Optional CSV fallback for subnet ids
        required: false
        default: ""
      security_group_ids:
        description: Optional CSV fallback for security group ids
        required: false
        default: ""
      desired_count:
        description: ECS service desired count
        required: false
        default: "1"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-telegram-bot-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region || vars.AWS_REGION || 'us-east-1' }}
      NAME_PREFIX: ${{ inputs.name_prefix || vars.RONIN_NAME_PREFIX || 'ronin' }}
      TELEGRAM_BOT_TOKEN_REF: ${{ inputs.telegram_bot_token_ref || vars.RONIN_TELEGRAM_BOT_TOKEN_REF || '/ronin/telegram/bot_token' }}
      TELEGRAM_CHAT_ID_REF: ${{ inputs.telegram_chat_id_ref || vars.RONIN_TELEGRAM_CHAT_ID_REF || '/ronin/telegram/chat_id' }}
      ECR_REPOSITORY: ${{ vars.RONIN_ECR_REPOSITORY || '' }}
      ECS_CLUSTER: ${{ vars.RONIN_ECS_CLUSTER || '' }}
      BASE_TASK_FAMILY: ${{ vars.RONIN_BASE_TASK_FAMILY || '' }}
      TELEGRAM_TASK_FAMILY: ${{ vars.RONIN_TELEGRAM_TASK_FAMILY || '' }}
      TELEGRAM_SERVICE_NAME: ${{ vars.RONIN_TELEGRAM_SERVICE_NAME || '' }}
      SUBNET_IDS: ${{ inputs.subnet_ids || vars.RONIN_WORKER_SUBNET_IDS || '' }}
      SECURITY_GROUP_IDS: ${{ inputs.security_group_ids || vars.RONIN_WORKER_SECURITY_GROUP_IDS || '' }}
      DESIRED_COUNT: ${{ inputs.desired_count || vars.RONIN_TELEGRAM_DESIRED_COUNT || '1' }}
      IMAGE_TAG: ${{ inputs.image_tag || github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Deploy Telegram bot service
        shell: bash
        run: ./.github/scripts/deploy_telegram_ecs.sh
